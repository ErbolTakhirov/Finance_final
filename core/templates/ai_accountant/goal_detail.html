{% extends "base.html" %}

{% block title %}{{ goal.title }} - AI Коуч{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'ai_accountant_dashboard' %}">AI Бухгалтер</a></li>
        <li class="breadcrumb-item active">{{ goal.title }}</li>
    </ol>
</nav>

<div class="row g-4">
    <div class="col-md-7">
        <div class="app-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h2 class="mb-1">{{ goal.title }}</h2>
                    <p class="text-muted">{{ goal.description }}</p>
                </div>
                <div class="text-end">
                    <h3 class="mb-0 text-primary">{{ goal.progress_percentage|floatformat:0 }}%</h3>
                    <small class="text-muted">выполнено</small>
                </div>
            </div>
            
            <div class="progress mb-4" style="height: 12px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: {{ goal.progress_percentage }}%"></div>
            </div>
            
            <div class="row text-center g-3">
                <div class="col-4">
                    <div class="p-2 border rounded">
                        <small class="text-muted d-block">Цель</small>
                        <span class="fw-bold">{{ goal.target_amount }}</span>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2 border rounded">
                        <small class="text-muted d-block">Накоплено</small>
                        <span class="fw-bold">{{ goal.current_amount }}</span>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2 border rounded">
                        <small class="text-muted d-block">Осталось</small>
                        <span class="fw-bold">{{ goal.target_amount|add:"-goal.current_amount"|default:0 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-card p-4">
            <h4 class="app-section-title mb-3">История прибыли и прогноз</h4>
            <canvas id="profitChart" height="200"></canvas>
            <div class="mt-4 p-3 bg-light rounded">
                <h5><i class="bi bi-graph-up text-primary"></i> Прогноз от AI</h5>
                <p id="forecastExplanation">{{ forecast_explanation|linebreaks }}</p>
                {% if forecast_profit %}
                <div class="alert alert-info py-2">
                    Ожидаемая прибыль в след. месяце: <strong>{{ forecast_profit|floatformat:2 }}</strong>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-5">
        <div class="app-card p-4 mb-4 border-primary border-2">
            <h4 class="app-section-title mb-3 text-primary"><i class="bi bi-lightning-charge"></i> AI-коуч по цели</h4>
            <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem; font-weight: bold;">
                        {{ probability }}%
                    </div>
                </div>
                <div>
                    <h5 class="mb-0">Шанс успеха</h5>
                    <small class="text-muted">оценка на основе текущих трат</small>
                </div>
            </div>
            
            <div class="advice-content p-3 rounded bg-primary-subtle text-primary-emphasis mb-3">
                {{ advice|linebreaks }}
            </div>
            
            <div class="mb-0">
                <small class="d-block text-muted">Прогноз даты достижения:</small>
                <h5 class="{% if goal.projected_date_if_current_trend > goal.target_date %}text-danger{% else %}text-success{% endif %}">
                    {{ goal.projected_date_if_current_trend|date:"d F Y"|default:"Не определено" }}
                </h5>
                {% if goal.projected_date_if_current_trend > goal.target_date %}
                <small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Это позже вашего дедлайна ({{ goal.target_date|date:"d.m.Y" }})</small>
                {% endif %}
            </div>
        </div>
        
        <div class="app-card p-4">
            <h5 class="mb-3">Режим "Что если?"</h5>
            <div class="mb-3">
                <label class="form-label small">Если я увеличу доход на:</label>
                <div class="input-group input-group-sm">
                    <input type="number" id="incomeChange" class="form-control" value="0" step="500">
                    <span class="input-group-text">{{ user.teen_profile.currency|default:"KGS" }}</span>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label small">Если я сокращу расходы на:</label>
                <div class="input-group input-group-sm">
                    <input type="number" id="expenseChange" class="form-control" value="0" step="500">
                    <span class="input-group-text">{{ user.teen_profile.currency|default:"KGS" }}</span>
                </div>
            </div>
            <button id="whatIfBtn" class="btn btn-primary btn-sm w-100">Пересчитать</button>
            
            <div id="whatIfResult" class="mt-3 d-none p-2 rounded bg-light border">
                <small class="text-muted d-block">Новая дата достижения:</small>
                <h6 id="newDateResult" class="mb-1"></h6>
                <small class="text-muted d-block">Новая прибыль:</small>
                <h6 id="newProfitResult" class="mb-0"></h6>
            </div>
        </div>
    </div>
</div>

<script>
const ctx = document.getElementById('profitChart').getContext('2d');
const historyData = {{ history_data_json|safe }};

new Chart(ctx, {
    type: 'line',
    data: {
        labels: historyData.map(d => d.month),
        datasets: [{
            label: 'Чистая прибыль',
            data: historyData.map(d => d.profit),
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: false }
        }
    }
});

document.getElementById('whatIfBtn').addEventListener('click', function() {
    const inc = document.getElementById('incomeChange').value;
    const exp = document.getElementById('expenseChange').value;
    
    fetch(`{% url "api_ai_whatif" %}?goal_id={{ goal.id }}&income_change=${inc}&expense_change=${exp}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('whatIfResult').classList.remove('d-none');
            document.getElementById('newDateResult').innerText = data.new_date;
            document.getElementById('newProfitResult').innerText = data.new_profit.toFixed(2);
        });
});
</script>
{% endblock %}
